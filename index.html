<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Orange Earn Pro üçä</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #E74C3C; --secondary-color: #F39C12;
            --background-light: #F8F9F9; --surface-light: #FFFFFF; --text-primary-light: #2C3E50; --text-secondary-light: #808B96; --border-light: #EAEDED;
            --background-dark: #121B22; --surface-dark: #1F2C34; --text-primary-dark: #FDFEFE; --text-secondary-dark: #ABB2B9; --border-dark: #2A3942;
            --success: #27AE60; --danger: #C0392B; --telegram-color: #24A1DE;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); padding-top: 80px; padding-bottom: 90px; }
        body.light-theme { background-color: var(--background-light); color: var(--text-primary-light); }
        body.dark-theme { background-color: var(--background-dark); color: var(--text-primary-dark); }
        #app { max-width: 500px; margin: 0 auto; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; max-width: 500px; margin: 0 auto;
        }
        .light-theme .header { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-light); }
        .dark-theme .header { background: rgba(31, 44, 52, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-dark); }
        .header-left { display: flex; align-items: center; gap: 10px; }
        #user-photo { width: 45px; height: 45px; border-radius: 12px; border: 2px solid var(--primary-color); }
        .balance-info h4 { font-size: 0.75rem; font-weight: 500; opacity: 0.7; }
        .balance-info p { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); }
        .withdraw-badge {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }

        /* STAT CARDS */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-box { padding: 15px; border-radius: 15px; text-align: center; border: 1px solid; }
        .light-theme .stat-box { background: #fff; border-color: var(--border-light); }
        .dark-theme .stat-box { background: var(--surface-dark); border-color: var(--border-dark); }
        .stat-box i { font-size: 1.2rem; margin-bottom: 8px; color: var(--secondary-color); }
        .stat-box h5 { font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px; }
        .stat-box p { font-size: 1.1rem; font-weight: 700; }

        /* NAVIGATION */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto;
            height: 75px; display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid; z-index: 1000; padding-bottom: 5px;
        }
        .light-theme .nav-bar { background: #fff; border-color: var(--border-light); }
        .dark-theme .nav-bar { background: var(--surface-dark); border-color: var(--border-dark); }
        .nav-item { border: none; background: none; color: var(--text-secondary-dark); cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item span { font-size: 0.7rem; font-weight: 500; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); }

        /* PROFILE SECTION */
        .profile-card { text-align: center; padding: 30px 20px; border-radius: 20px; margin-bottom: 20px; }
        .light-theme .profile-card { background: #fff; border: 1px solid var(--border-light); }
        .dark-theme .profile-card { background: var(--surface-dark); border: 1px solid var(--border-dark); }
        .profile-img-lg { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary-color); margin-bottom: 15px; }
        .profile-detail { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid; font-size: 0.9rem; }
        .light-theme .profile-detail { border-color: #f1f1f1; }
        .dark-theme .profile-detail { border-color: var(--border-dark); }

        /* ACTION BUTTONS */
        .btn-primary { width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; font-weight: 600; font-size: 1rem; cursor: pointer; }
        .btn-primary:disabled { background: #566573; }

        /* INPUTS */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid; background: transparent; color: inherit; }
        .light-theme input, .light-theme select { border-color: var(--border-light); }
        .dark-theme input, .dark-theme select { border-color: var(--border-dark); }

        /* REFERRAL BOX */
        .refer-box { padding: 20px; border-radius: 15px; background: rgba(36, 161, 222, 0.1); border: 1px dashed var(--telegram-color); text-align: center; }
        .refer-code { font-size: 1.2rem; font-weight: 700; color: var(--telegram-color); margin: 15px 0; letter-spacing: 2px; }

        /* POPOUTS / MODALS */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 10001; padding: 20px; }
        .popup-content { width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; position: relative; }
        .light-theme .popup-content { background: #fff; } .dark-theme .popup-content { background: var(--surface-dark); }
        .close-popup { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; }

        /* TASK UI */
        .task-card { display: flex; align-items: center; gap: 12px; padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid; }
        .light-theme .task-card { background: #fff; border-color: var(--border-light); }
        .dark-theme .task-card { background: var(--surface-dark); border-color: var(--border-dark); }
        .task-icon { width: 45px; height: 45px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1.2rem; }
        .task-info { flex: 1; }
        .task-info h4 { font-size: 0.95rem; }
        .task-info p { font-size: 0.75rem; opacity: 0.7; }
        .task-btn { padding: 8px 15px; border-radius: 8px; border: none; background: var(--primary-color); color: white; font-size: 0.8rem; font-weight: 600; cursor: pointer; }

        /* LEADERBOARD */
        .lb-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); }
        .rank-circle { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; background: var(--primary-color); color: white; font-size: 0.8rem; }
        
        #app-loader { position: fixed; inset: 0; z-index: 10002; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .light-theme #app-loader { background: #fff; } .dark-theme #app-loader { background: var(--background-dark); }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="dark-theme"> <div id="app-loader">
        <div class="spinner"></div>
        <p id="load-txt" style="margin-top: 15px; font-weight: 600;">Initializing...</p>
    </div>

    <div id="withdraw-modal" class="popup-overlay">
        <div class="popup-content">
            <span class="close-popup" onclick="closeWithdraw()">&times;</span>
            <h3 style="margin-bottom: 20px; text-align: center;">Withdraw Funds</h3>
            <form id="withdraw-form">
                <div class="input-group">
                    <label>Payment Method</label>
                    <select id="method-select" required></select>
                </div>
                <div class="input-group">
                    <label>Account Number</label>
                    <input type="text" id="account-num" placeholder="e.g. 017xxxxxxxx" required>
                </div>
                <div class="input-group">
                    <label>Amount (TK)</label>
                    <input type="number" id="amount-input" placeholder="0.00" required>
                </div>
                <button type="submit" class="btn-primary" id="withdraw-btn">Submit Request</button>
            </form>
        </div>
    </div>

    <div id="app" style="display: none;">
        <header class="header">
            <div class="header-left">
                <img id="user-photo" src="" alt="">
                <div class="balance-info">
                    <h4>Main Balance</h4>
                    <p><span id="header-balance">0.00</span> TK</p>
                </div>
            </div>
            <button class="withdraw-badge" onclick="openWithdraw()">Withdraw</button>
        </header>

        <div id="home-page" class="page active">
            <div class="stats-row">
                <div class="stat-box">
                    <i class="fas fa-play-circle"></i>
                    <h5>Today's Ads</h5>
                    <p id="stat-daily-ads">0/0</p>
                </div>
                <div class="stat-box">
                    <i class="fas fa-chart-line"></i>
                    <h5>Total Earned</h5>
                    <p id="stat-total-earn">0.00</p>
                </div>
            </div>
            
            <h3 style="margin-bottom: 15px;">Main Tasks</h3>
            <div id="ad-task-container"></div>
            
            <h3 style="margin: 20px 0 15px;">Important Links</h3>
            <div id="links-container"></div>
        </div>

        <div id="tasks-page" class="page">
            <h3 style="margin-bottom: 15px;">Bonus Tasks</h3>
            <div id="bonus-tasks-container"></div>
        </div>

        <div id="refer-page" class="page">
            <div class="refer-box">
                <i class="fas fa-gift" style="font-size: 3rem; color: var(--telegram-color); margin-bottom: 10px;"></i>
                <h3>Refer & Earn</h3>
                <p style="font-size: 0.85rem; opacity: 0.8;">Invite friends and get bonus TK for every person who joins using your link.</p>
                <div class="refer-code" id="my-refer-id">-------</div>
                <button class="btn-primary" onclick="copyRefLink()" style="background: var(--telegram-color);">Copy Referral Link</button>
                <button class="btn-primary" onclick="shareRefLink()" style="margin-top: 10px; background: #25D366; border: none;">Share on Telegram</button>
            </div>
            
            <div class="stat-box" style="margin-top: 20px; display: flex; justify-content: space-around; align-items: center;">
                <div>
                    <h5>Referral Bonus</h5>
                    <p><span id="ref-bonus-val">0</span> TK</p>
                </div>
                <div style="width: 1px; height: 40px; background: var(--border-dark);"></div>
                <div>
                    <h5>Total Referrals</h5>
                    <p id="stat-total-ref">0</p>
                </div>
            </div>
        </div>

        <div id="leaderboard-page" class="page">
            <h3 style="margin-bottom: 20px; text-align: center;">Top 7 Earners</h3>
            <div id="leaderboard-list"></div>
            <div id="my-rank-sticky" style="margin-top: 20px; padding: 15px; border-radius: 12px; background: rgba(231, 76, 60, 0.1); border: 1px solid var(--primary-color);">
                </div>
        </div>

        <div id="profile-page" class="page">
            <div class="profile-card">
                <img id="profile-img-big" class="profile-img-lg" src="" alt="Profile">
                <h2 id="profile-name">User Name</h2>
                <p style="opacity: 0.6; font-size: 0.85rem;" id="profile-username">@username</p>
            </div>

            <div class="profile-detail">
                <span>Account ID</span>
                <span id="prof-id" style="font-weight: 600;">000000</span>
            </div>
            <div class="profile-detail">
                <span>Status</span>
                <span style="color: var(--success); font-weight: 600;">Verified User</span>
            </div>
            <div class="profile-detail">
                <span>Joined Date</span>
                <span id="prof-joined">---</span>
            </div>

            <h3 style="margin: 25px 0 15px;">Withdrawal History</h3>
            <div id="history-list"></div>
        </div>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="showPage('home-page', this)"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-item" onclick="showPage('tasks-page', this)"><i class="fas fa-th-list"></i><span>Tasks</span></button>
            <button class="nav-item" onclick="showPage('refer-page', this)"><i class="fas fa-user-plus"></i><span>Refer</span></button>
            <button class="nav-item" onclick="showPage('leaderboard-page', this)"><i class="fas fa-trophy"></i><span>Top</span></button>
            <button class="nav-item" onclick="showPage('profile-page', this)"><i class="fas fa-user-circle"></i><span>Profile</span></button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        const firebaseConfig = {
            apiKey: "AIzaSyBLiCGAU2qQ1qa1IuzaerZYPlwsr93Hs_s",
            authDomain: "bigger-88989.firebaseapp.com",
            databaseURL: "https://bigger-88989-default-rtdb.firebaseio.com",
            projectId: "bigger-88989",
            storageBucket: "bigger-88989.firebasestorage.app",
            messagingSenderId: "288559349702",
            appId: "1:288559349702:web:9232a6bca6ec1ade4a3cc7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userState = {};
        let config = {};

        function openWithdraw() { document.getElementById('withdraw-modal').style.display = 'flex'; }
        function closeWithdraw() { document.getElementById('withdraw-modal').style.display = 'none'; }

        function showPage(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(pageId === 'leaderboard-page') loadLeaderboard();
        }

        async function init() {
            tg.ready();
            tg.expand();
            const user = tg.initDataUnsafe.user;
            if(!user) return;

            // Load Config
            const confSnap = await db.ref('config').once('value');
            config = confSnap.val();

            // Setup Withdraw Methods
            const methodSelect = document.getElementById('method-select');
            config.withdrawMethods.forEach(m => {
                methodSelect.innerHTML += `<option value="${m.name}">${m.name} (Min: ${m.min} TK)</option>`;
            });
            document.getElementById('ref-bonus-val').innerText = config.referralBonus;

            // Load/Create User
            const userRef = db.ref('users/' + user.id);
            const userSnap = await userRef.once('value');
            if(!userSnap.exists()) {
                const refBy = tg.initDataUnsafe.start_param || null;
                userState = {
                    id: user.id,
                    name: user.first_name + (user.last_name ? ' ' + user.last_name : ''),
                    username: user.username || 'user',
                    photo: user.photo_url || 'https://via.placeholder.com/100',
                    balance: 0,
                    totalEarned: 0,
                    referrals: 0,
                    referredBy: refBy,
                    dailyAdCount: 0,
                    lastAdDate: new Date().toDateString(),
                    joinedDate: new Date().toLocaleDateString()
                };
                await userRef.set(userState);
                if(refBy) {
                    db.ref('users/' + refBy).transaction(u => {
                        if(u) {
                            u.balance = (u.balance || 0) + (config.referralBonus || 0);
                            u.referrals = (u.referrals || 0) + 1;
                        }
                        return u;
                    });
                }
            } else {
                userState = userSnap.val();
                if(userState.lastAdDate !== new Date().toDateString()) {
                    userState.dailyAdCount = 0;
                    userState.lastAdDate = new Date().toDateString();
                    userRef.update({ dailyAdCount: 0, lastAdDate: userState.lastAdDate });
                }
            }

            renderUI();
            loadAdSdk();
            document.getElementById('app-loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        function renderUI() {
            document.getElementById('user-photo').src = userState.photo;
            document.getElementById('profile-img-big').src = userState.photo;
            document.getElementById('header-balance').innerText = userState.balance.toFixed(2);
            document.getElementById('stat-daily-ads').innerText = `${userState.dailyAdCount}/${config.dailyAdLimit}`;
            document.getElementById('stat-total-earn').innerText = userState.totalEarned.toFixed(2);
            document.getElementById('stat-total-ref').innerText = userState.referrals;
            document.getElementById('my-refer-id').innerText = userState.id;
            document.getElementById('profile-name').innerText = userState.name;
            document.getElementById('profile-username').innerText = '@' + userState.username;
            document.getElementById('prof-id').innerText = userState.id;
            document.getElementById('prof-joined').innerText = userState.joinedDate || '---';

            renderTasks();
            renderHistory();
        }

        function renderTasks() {
            // Main Ad Task
            const adCont = document.getElementById('ad-task-container');
            adCont.innerHTML = `
                <div class="task-card">
                    <div class="task-icon"><i class="fas fa-play"></i></div>
                    <div class="task-info">
                        <h4>Rewarded Video Ad</h4>
                        <p>Watch and earn ${config.adValue} TK instantly</p>
                    </div>
                    <button class="task-btn" onclick="watchAd()" ${userState.dailyAdCount >= config.dailyAdLimit ? 'disabled' : ''}>
                        ${userState.dailyAdCount >= config.dailyAdLimit ? 'Limit Reach' : 'Watch'}
                    </button>
                </div>
            `;

            // Bonus Tasks
            const bonusCont = document.getElementById('bonus-tasks-container');
            bonusCont.innerHTML = '';
            for(let key in config.tasks) {
                const t = config.tasks[key];
                bonusCont.innerHTML += `
                    <div class="task-card">
                        <div class="task-icon"><i class="fab fa-youtube"></i></div>
                        <div class="task-info">
                            <h4>${t.name}</h4>
                            <p>Reward: ${t.reward} TK</p>
                        </div>
                        <button class="task-btn" onclick="tg.openLink('${t.url}')">Complete</button>
                    </div>
                `;
            }
        }

        async function watchAd() {
            const adFn = window['show_' + config.adZoneId];
            if(typeof adFn !== 'function') return tg.showAlert("Ad SDK not ready");

            try {
                await adFn();
                userState.balance += config.adValue;
                userState.totalEarned += config.adValue;
                userState.dailyAdCount += 1;
                await db.ref('users/' + userState.id).update({
                    balance: userState.balance,
                    totalEarned: userState.totalEarned,
                    dailyAdCount: userState.dailyAdCount
                });
                tg.showAlert(`Success! +${config.adValue} TK added.`);
                renderUI();
            } catch(e) {
                tg.showAlert("Ad failed to load.");
            }
        }

        async function loadLeaderboard() {
            const snap = await db.ref('users').orderByChild('totalEarned').limitToLast(50).once('value');
            let list = [];
            snap.forEach(child => { list.push(child.val()); });
            list.reverse();

            const cont = document.getElementById('leaderboard-list');
            cont.innerHTML = '';
            for(let i=0; i<Math.min(list.length, 7); i++) {
                const u = list[i];
                cont.innerHTML += `
                    <div class="lb-item">
                        <div class="rank-circle">${i+1}</div>
                        <img src="${u.photo}" style="width:35px; height:35px; border-radius:50%">
                        <span style="flex:1">${u.name}</span>
                        <span style="font-weight:700">${u.totalEarned.toFixed(2)} TK</span>
                    </div>
                `;
            }

            const myIdx = list.findIndex(u => u.id == userState.id);
            const myRankCont = document.getElementById('my-rank-sticky');
            if(myIdx >= 7) {
                myRankCont.style.display = 'block';
                myRankCont.innerHTML = `
                    <div class="lb-item" style="background:transparent; margin:0">
                        <div class="rank-circle" style="background: #333">#${myIdx+1}</div>
                        <span style="flex:1">Your Global Rank</span>
                        <span style="font-weight:700">${userState.totalEarned.toFixed(2)} TK</span>
                    </div>
                `;
            } else {
                myRankCont.style.display = 'none';
            }
        }

        function renderHistory() {
            db.ref('withdrawals/pending').orderByChild('userId').equalTo(userState.id).once('value', snap => {
                const cont = document.getElementById('history-list');
                cont.innerHTML = '';
                if(!snap.exists()) cont.innerHTML = '<p style="text-align:center; opacity:0.5; font-size:0.8rem;">No history found</p>';
                snap.forEach(child => {
                    const w = child.val();
                    cont.innerHTML += `
                        <div class="profile-detail">
                            <span>${w.method} - ${w.amount}TK</span>
                            <span style="color:var(--secondary-color)">Pending</span>
                        </div>
                    `;
                });
            });
        }

        function loadAdSdk() {
            const s = document.createElement('script');
            s.src = '//libtl.com/sdk.js';
            s.setAttribute('data-zone', config.adZoneId);
            s.setAttribute('data-sdk', 'show_' + config.adZoneId);
            document.body.appendChild(s);
        }

        function copyRefLink() {
            const link = `https://t.me/${config.botUsername}/app?startapp=${userState.id}`;
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            tg.showAlert("Link copied to clipboard!");
        }

        function shareRefLink() {
            const link = `https://t.me/${config.botUsername}/app?startapp=${userState.id}`;
            const text = encodeURIComponent("Join Orange Earn and earn money daily! üçä\n\nSign up now: " + link);
            tg.openTelegramLink(`https://t.me/share/url?url=${link}&text=${text}`);
        }

        document.getElementById('withdraw-form').onsubmit = async (e) => {
            e.preventDefault();
            const method = document.getElementById('method-select').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            const account = document.getElementById('account-num').value;
            const mData = config.withdrawMethods.find(m => m.name === method);

            if(amount < mData.min) return tg.showAlert(`Min withdraw for ${method} is ${mData.min} TK`);
            if(amount > userState.balance) return tg.showAlert("Insufficient balance");

            const btn = document.getElementById('withdraw-btn');
            btn.disabled = true; btn.innerText = "Processing...";

            const newReq = {
                userId: userState.id,
                name: userState.name,
                method, amount, account,
                status: 'pending',
                date: new Date().toLocaleString()
            };

            await db.ref('withdrawals/pending').push(newReq);
            userState.balance -= amount;
            await db.ref('users/' + userState.id).update({ balance: userState.balance });
            
            tg.showAlert("Withdrawal request submitted!");
            closeWithdraw();
            renderUI();
            btn.disabled = false; btn.innerText = "Submit Request";
        };

        init();
    </script>
</body>
</html>
