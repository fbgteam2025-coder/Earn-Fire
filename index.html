<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Orange Earn Ultra üçä</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root {
            --primary: #FF5722; --accent: #FFC107;
            --bg: #0F172A; --card-bg: #1E293B;
            --text-main: #F8FAFC; --text-dim: #94A3B8;
            --telegram: #0088CC; --success: #22C55E;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); padding-top: 80px; padding-bottom: 90px; overflow-x: hidden; }
        #app { max-width: 500px; margin: 0 auto; }
        .page { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; max-width: 500px; margin: 0 auto;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .header-user { display: flex; align-items: center; gap: 12px; }
        #u-img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary); background: #334155; }
        .u-bal-val { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .wd-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 12px; font-weight: 600; font-size: 0.85rem; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3); }

        /* PREMIUM REFER PAGE */
        .refer-hero {
            background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%);
            padding: 30px 20px; border-radius: 24px; text-align: center; margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .refer-hero i { position: absolute; opacity: 0.1; font-size: 10rem; right: -20px; bottom: -20px; }
        .refer-link-box {
            background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
            padding: 12px; border-radius: 15px; margin-top: 15px; display: flex; align-items: center; justify-content: space-between;
        }
        .ref-input { background: none; border: none; color: white; width: 70%; font-size: 0.85rem; }
        .copy-ico { color: white; cursor: pointer; padding: 5px; }

        /* FRIENDS LIST */
        .friend-list { margin-top: 20px; background: var(--card-bg); border-radius: 20px; padding: 15px; }
        .friend-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .friend-item:last-child { border-bottom: none; }
        .friend-item img { width: 35px; height: 35px; border-radius: 50%; }

        /* TASK CARD */
        .task-card { background: var(--card-bg); padding: 15px; border-radius: 18px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .task-ico { width: 45px; height: 45px; border-radius: 12px; background: rgba(255, 87, 34, 0.1); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.3rem; }
        .task-info { flex: 1; }
        .task-info h4 { font-size: 0.95rem; margin-bottom: 2px; }
        .task-info p { font-size: 0.75rem; color: var(--text-dim); }
        .claim-btn { background: #334155; color: white; border: none; padding: 8px 14px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
        .claim-btn.ready { background: var(--primary); }

        /* NAV BAR */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto;
            height: 75px; background: #1E293B; display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000;
        }
        .nav-item { border: none; background: none; color: var(--text-dim); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: 0.3s; }
        .nav-item i { font-size: 1.3rem; }
        .nav-item span { font-size: 0.7rem; font-weight: 500; }
        .nav-item.active { color: var(--primary); }

        /* WITHDRAW MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; padding: 25px; border-radius: 24px; position: relative; }
        .m-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: var(--text-dim); cursor: pointer; }
        .m-input { width: 100%; background: #0F172A; border: 1px solid #334155; color: white; padding: 12px; border-radius: 12px; margin-top: 8px; margin-bottom: 15px; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spin { width: 45px; height: 45px; border: 4px solid #334155; border-top-color: var(--primary); border-radius: 50%; animation: rot 1s linear infinite; }
        @keyframes rot { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spin"></div><p style="margin-top:15px; color:var(--text-dim)">Loading Data...</p></div>

    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <span class="m-close" onclick="closeWD()">&times;</span>
            <h3 style="text-align:center; margin-bottom:20px;">Withdraw Earnings</h3>
            <label style="font-size:0.85rem; color:var(--text-dim)">Select Method</label>
            <select id="wd-method" class="m-input"></select>
            <label style="font-size:0.85rem; color:var(--text-dim)">Account Number</label>
            <input type="text" id="wd-acc" class="m-input" placeholder="017xxxxxxxx">
            <label style="font-size:0.85rem; color:var(--text-dim)">Amount (TK)</label>
            <input type="number" id="wd-amt" class="m-input" placeholder="0.00">
            <button class="wd-btn" style="width:100%; padding:14px;" onclick="handleWithdraw()">Submit Withdrawal</button>
        </div>
    </div>

    <div id="app" style="display:none;">
        <header class="header">
            <div class="header-user">
                <img id="u-img" src="" alt="">
                <div>
                    <p style="font-size:0.7rem; color:var(--text-dim)">Balance</p>
                    <p class="u-bal-val"><span id="u-bal">0.00</span> TK</p>
                </div>
            </div>
            <button class="wd-btn" onclick="openWD()">Withdraw</button>
        </header>

        <div id="home-page" class="page active">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:25px;">
                <div class="task-card" style="margin:0; padding:12px;">
                    <i class="fas fa-play-circle" style="color:var(--accent)"></i>
                    <div><p style="font-size:0.7rem; color:var(--text-dim)">Daily Ads</p><h4 id="h-ads">0/0</h4></div>
                </div>
                <div class="task-card" style="margin:0; padding:12px;">
                    <i class="fas fa-wallet" style="color:var(--success)"></i>
                    <div><p style="font-size:0.7rem; color:var(--text-dim)">Total Earned</p><h4 id="h-earn">0.00</h4></div>
                </div>
            </div>
            <h3 style="margin-bottom:15px; font-size:1.1rem;">Main Earning</h3>
            <div id="main-ad-task"></div>
            <h3 style="margin:20px 0 15px; font-size:1.1rem;">Quick Links</h3>
            <div id="q-links"></div>
        </div>

        <div id="tasks-page" class="page">
            <h3 style="margin-bottom:20px;">Bonus Tasks</h3>
            <div id="bonus-tasks-list"></div>
        </div>

        <div id="refer-page" class="page">
            <div class="refer-hero">
                <i class="fas fa-bullhorn"></i>
                <h2 style="font-size:1.5rem; margin-bottom:5px;">Refer & Earn Pro</h2>
                <p style="font-size:0.85rem; opacity:0.9;">Invite friends and get <span id="ref-val">0</span> TK per friend!</p>
                <div class="refer-link-box">
                    <input type="text" id="ref-link" class="ref-input" readonly>
                    <i class="fas fa-copy copy-ico" onclick="copyRef()"></i>
                </div>
            </div>
            
            <h3 style="margin-bottom:15px; font-size:1.1rem;">Your Friends (<span id="friend-count">0</span>)</h3>
            <div class="friend-list" id="friend-list-cont">
                <p style="text-align:center; color:var(--text-dim); font-size:0.8rem; padding:20px;">No friends invited yet.</p>
            </div>
        </div>

        <div id="leaderboard-page" class="page">
            <h3 style="text-align:center; margin-bottom:20px;">Global Leaderboard</h3>
            <div id="lb-list"></div>
            <div id="my-rank-box" style="margin-top:20px;"></div>
        </div>

        <div id="profile-page" class="page">
            <div style="text-align:center; margin-bottom:30px;">
                <img id="p-img-big" src="" style="width:100px; height:100px; border-radius:50%; border:4px solid var(--primary); margin-bottom:15px;">
                <h2 id="p-name">---</h2>
                <p id="p-user" style="color:var(--text-dim)">@---</p>
            </div>
            <div class="task-card">
                <div class="task-info"><h4>User ID</h4><p id="p-id">000000</p></div>
            </div>
            <div class="task-card">
                <div class="task-info"><h4>Account Status</h4><p style="color:var(--success)">Active & Verified</p></div>
            </div>
            <h3 style="margin:20px 0 15px;">Recent Transactions</h3>
            <div id="p-history"></div>
        </div>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="nav('home-page', this)"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-item" onclick="nav('tasks-page', this)"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-item" onclick="nav('refer-page', this)"><i class="fas fa-user-plus"></i><span>Refer</span></button>
            <button class="nav-item" onclick="nav('leaderboard-page', this)"><i class="fas fa-trophy"></i><span>Top 7</span></button>
            <button class="nav-item" onclick="nav('profile-page', this)"><i class="fas fa-user-circle"></i><span>Profile</span></button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        const firebaseConfig = {
            apiKey: "AIzaSyBLiCGAU2qQ1qa1IuzaerZYPlwsr93Hs_s",
            authDomain: "bigger-88989.firebaseapp.com",
            databaseURL: "https://bigger-88989-default-rtdb.firebaseio.com",
            projectId: "bigger-88989",
            storageBucket: "bigger-88989.firebasestorage.app",
            messagingSenderId: "288559349702",
            appId: "1:288559349702:web:9232a6bca6ec1ade4a3cc7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let userState = {}; let appConfig = {};

        function openWD() { document.getElementById('withdraw-modal').style.display = 'flex'; }
        function closeWD() { document.getElementById('withdraw-modal').style.display = 'none'; }

        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(id === 'leaderboard-page') loadLB();
            if(id === 'refer-page') loadFriends();
        }

        async function init() {
            tg.ready(); tg.expand();
            const user = tg.initDataUnsafe.user;
            if(!user) return;

            // Load Config
            const confSnap = await db.ref('config').once('value');
            appConfig = confSnap.val();
            
            // Build Withdraw Select
            const ws = document.getElementById('wd-method');
            appConfig.withdrawMethods.forEach(m => ws.innerHTML += `<option value="${m.name}">${m.name} (Min ${m.min})</option>`);
            document.getElementById('ref-val').innerText = appConfig.referralBonus;

            // Load User with direct TG data
            const userRef = db.ref('users/' + user.id);
            const userSnap = await userRef.once('value');
            
            if(!userSnap.exists()) {
                const startParam = tg.initDataUnsafe.start_param;
                userState = {
                    id: user.id, name: user.first_name + ' ' + (user.last_name || ''),
                    username: user.username || 'user',
                    photo: user.photo_url || 'https://ui-avatars.com/api/?name='+user.first_name,
                    balance: 0, totalEarned: 0, referrals: 0,
                    lastAdDate: new Date().toDateString(), dailyAdCount: 0,
                    completedTasks: {}
                };
                await userRef.set(userState);
                if(startParam) handleRef(startParam, user);
            } else {
                userState = userSnap.val();
                // Update photo if changed in TG
                if(user.photo_url && userState.photo !== user.photo_url) {
                    userState.photo = user.photo_url;
                    userRef.update({ photo: user.photo_url });
                }
            }

            render();
            loadAdSdk();
            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        function handleRef(refId, newUser) {
            if(refId == newUser.id) return;
            db.ref('users/' + refId).transaction(u => {
                if(u) {
                    u.balance = (u.balance || 0) + (appConfig.referralBonus || 0);
                    u.referrals = (u.referrals || 0) + 1;
                }
                return u;
            });
            // Record friend relationship
            db.ref('referrals/' + refId).push({
                id: newUser.id, name: newUser.first_name, photo: newUser.photo_url || ''
            });
        }

        function render() {
            document.getElementById('u-img').src = userState.photo;
            document.getElementById('p-img-big').src = userState.photo;
            document.getElementById('u-bal').innerText = userState.balance.toFixed(2);
            document.getElementById('h-ads').innerText = `${userState.dailyAdCount}/${appConfig.dailyAdLimit}`;
            document.getElementById('h-earn').innerText = userState.totalEarned.toFixed(2);
            document.getElementById('ref-link').value = `https://t.me/${appConfig.botUsername}/app?startapp=${userState.id}`;
            document.getElementById('p-name').innerText = userState.name;
            document.getElementById('p-user').innerText = '@' + userState.username;
            document.getElementById('p-id').innerText = userState.id;
            
            renderTasks();
        }

        function renderTasks() {
            const adCont = document.getElementById('main-ad-task');
            adCont.innerHTML = `
                <div class="task-card">
                    <div class="task-ico"><i class="fas fa-play"></i></div>
                    <div class="task-info"><h4>Rewarded Video Ad</h4><p>Earn ${appConfig.adValue} TK instantly</p></div>
                    <button class="claim-btn ready" onclick="watchAd()">Watch</button>
                </div>`;

            const bonusCont = document.getElementById('bonus-tasks-list');
            bonusCont.innerHTML = '';
            for(let key in appConfig.tasks) {
                const t = appConfig.tasks[key];
                const done = userState.completedTasks && userState.completedTasks[key];
                bonusCont.innerHTML += `
                    <div class="task-card">
                        <div class="task-ico"><i class="${t.type === 'telegram' ? 'fab fa-telegram-plane' : 'fab fa-youtube'}"></i></div>
                        <div class="task-info"><h4>${t.name}</h4><p>Reward: ${t.reward} TK</p></div>
                        <button class="claim-btn ${done ? '' : 'ready'}" onclick="handleBonus('${key}')">${done ? 'Claimed' : 'Join'}</button>
                    </div>`;
            }
        }

        async function handleBonus(key) {
            const task = appConfig.tasks[key];
            if(userState.completedTasks && userState.completedTasks[key]) return;
            
            tg.openLink(task.url);
            
            // Wait 5 seconds and auto-claim (Telegram API member check requires Bot Token on Backend)
            // For Client-side, we simulate a check
            setTimeout(async () => {
                userState.balance += task.reward;
                if(!userState.completedTasks) userState.completedTasks = {};
                userState.completedTasks[key] = true;
                
                await db.ref('users/' + userState.id).update({
                    balance: userState.balance,
                    completedTasks: userState.completedTasks
                });
                tg.showAlert(`Bonus Claimed! +${task.reward} TK`);
                render();
            }, 6000);
        }

        async function watchAd() {
            if(userState.dailyAdCount >= appConfig.dailyAdLimit) return tg.showAlert("Daily limit reached!");
            const adFn = window['show_' + appConfig.adZoneId];
            if(typeof adFn !== 'function') return tg.showAlert("Ad SDK Error");
            
            try {
                await adFn();
                userState.balance += appConfig.adValue;
                userState.totalEarned += appConfig.adValue;
                userState.dailyAdCount++;
                await db.ref('users/' + userState.id).update({
                    balance: userState.balance, totalEarned: userState.totalEarned, dailyAdCount: userState.dailyAdCount
                });
                render();
                tg.showAlert("Success! Reward added.");
            } catch(e) { tg.showAlert("Ad not completed."); }
        }

        async function loadFriends() {
            const snap = await db.ref('referrals/' + userState.id).once('value');
            const cont = document.getElementById('friend-list-cont');
            document.getElementById('friend-count').innerText = snap.numChildren();
            if(!snap.exists()) return;
            cont.innerHTML = '';
            snap.forEach(child => {
                const f = child.val();
                cont.innerHTML += `<div class="friend-item">
                    <img src="${f.photo || 'https://ui-avatars.com/api/?name='+f.name}" alt="">
                    <span style="font-size:0.9rem;">${f.name}</span>
                    <span style="margin-left:auto; color:var(--success); font-size:0.7rem;">Verified</span>
                </div>`;
            });
        }

        async function loadLB() {
            const snap = await db.ref('users').orderByChild('totalEarned').limitToLast(50).once('value');
            let list = []; snap.forEach(c => list.push(c.val())); list.reverse();
            const cont = document.getElementById('lb-list'); cont.innerHTML = '';
            for(let i=0; i<Math.min(list.length, 7); i++) {
                const u = list[i];
                cont.innerHTML += `<div class="task-card" style="background:${u.id==userState.id?'rgba(255,87,34,0.1)':'#1E293B'}">
                    <div style="font-weight:bold; color:var(--primary); width:25px;">#${i+1}</div>
                    <img src="${u.photo}" style="width:35px; height:35px; border-radius:50%">
                    <div class="task-info"><h4>${u.name}</h4></div>
                    <div style="font-weight:bold;">${u.totalEarned.toFixed(2)}</div>
                </div>`;
            }
            const myIdx = list.findIndex(u => u.id == userState.id);
            if(myIdx >= 7) {
                document.getElementById('my-rank-box').innerHTML = `<div class="task-card" style="border:1px solid var(--primary)">
                    <div style="font-weight:bold; color:var(--primary); width:25px;">#${myIdx+1}</div>
                    <div class="task-info"><h4>Your Global Rank</h4></div>
                    <div style="font-weight:bold;">${userState.totalEarned.toFixed(2)}</div>
                </div>`;
            }
        }

        function copyRef() {
            const link = document.getElementById('ref-link');
            link.select();
            document.execCommand('copy');
            tg.showAlert("Referral link copied!");
        }

        function loadAdSdk() {
            const s = document.createElement('script');
            s.src = '//libtl.com/sdk.js';
            s.setAttribute('data-zone', appConfig.adZoneId);
            s.setAttribute('data-sdk', 'show_' + appConfig.adZoneId);
            document.body.appendChild(s);
        }

        init();
    </script>
</body>
</html>
